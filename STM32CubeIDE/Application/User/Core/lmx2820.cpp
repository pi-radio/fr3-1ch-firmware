/*
 * lmx2820.c
 *
 *  Created on: Jan 28, 2026
 *      Author: zapman
 */
#include <stdint.h>
#include <fr3_1ch_hw.h>
#include <lmx.h>

extern uint16_t lmx_default_regs[LMX2820::N_REGS];

extern "C" int dbgprint(const char *fmt, ...);

LMX2820 lmx;

LMX2820::LMX2820()
{
  dirty.set_all();

  memcpy(regs, lmx_default_regs, sizeof(regs));
}

void LMX2820::reprogram()
{
  dirty.set_all();

  program();
}

void LMX2820::program()
{
  int i;

  for (i = N_REGS - 1; i >= 0; i--) {
    if (dirty.get(i)) {
      lmx.program_reg(i);
    }
  }
}

void LMX2820::program_reg(int reg)
{
  uint32_t v = (reg << 16) | regs[reg];

#if 0
  spi_transmit(SPI_DEVICE_LMX, 3, v);
#else
  spi_transfer(SPI_DEVICE_LMX, 3, &v);
#endif

  dirty.clear(reg);
}

int LMX2820::read_reg(int reg, uint16_t *val) {
  int retval;

  uint32_t v = (reg << 16) | regs[reg];

  retval = spi_transfer(SPI_DEVICE_LMX, 3, &v);

  *val = (v & 0xFFFF);

  return retval;
}

int LMX2820::locked()
{
  uint16_t v;
  int retval = read_reg(74, &v);

  if (retval < 0) {
    return false;
  }

  v = (v >> 14) & 0x3;

  switch (v) {
  case 0:
  case 1:
    retval = 0;
    break;
  case 2:
    retval = 1;
    break;
  default:
    retval = -1;
    break;
  }

  return retval;
}

extern "C" void lmx_program(void)
{
  lmx.program();
}

#ifndef OCTOLO

// Default 10MHz registers, 10 GHz output
uint16_t lmx_default_regs[LMX2820::N_REGS] = {
    0x6070,
    0x57a0,
    0x81f4,
    0x0041,
    0x4204,
    0x0032,
    0x0a43,
    0x0000,
    0xc802,
    0x0005,
    0x0000,
    0x0612,
    0x0408,
    0x0038,
    0x3001,
    0x2001,
    0x171c,
    0x15c0,
    0x0000,
    0x2120,
    0x272c,
    0x1c64,
    0xe2bf,
    0x1102,
    0x0e34,
    0x0624,
    0x0db0,
    0x8001,
    0x0639,
    0x318c,
    0xb18c,
    0x0401,
    0x1001,
    0x0000,
    0x0010,
    0x3100,
    0x01f4,
    0x0500,
    0x0000,
    0x03e8,
    0x0000,
    0x0000,
    0x0000,
    0x0000,
    0x0000,
    0x0000,
    0x0300,
    0x0300,
    0x4180,
    0x0000,
    0x0080,
    0x203f,
    0x0000,
    0x0000,
    0x0000,
    0x0002,
    0x0001,
    0x0001,
    0x0000,
    0x1388,
    0x01f4,
    0x03e8,
    0x0000,
    0xc350,
    0x0080,
    0x0000,
    0x003f,
    0x1000,
    0x0020,
    0x0011,
    0x000e,
    0x0000,
    0x0000,
    0x0000,
    0x0000,
    0x0000,
    0x0000,
    0x0608,
    0x0001,
    0x011e,
    0x01c0,
    0x0000,
    0x0000,
    0x0f00,
    0x0040,
    0x0000,
    0x0040,
    0xff00,
    0x03ff,
    0x0000,
    0x0000,
    0x0000,
    0x0000,
    0x1000,
    0x0000,
    0x0000,
    0x17f8,
    0x0000,
    0x1c80,
    0x19b9,
    0x0533,
    0x03e8,
    0x0028,
    0x0014,
    0x0014,
    0x000a,
    0x0000,
    0x0000,
    0x0000,
    0x0000,
    0x001f,
    0x0000,
    0xffff,
    0x0000,
    0x0000,
    0x0000,
    0x0000,
    0x0000,
    0x0000,
    0x0000,
    0x0000,
    0x0000,
    0x0000,
};

// Default 10MHz registers, 15 GHz output
uint16_t lmx_default_regs_15GHz[LMX2820::N_REGS] = {
		0x6070,
		0xD7A0,
		0x81F4,
		0x0041,
		0x4204,
		0x0032,
		0x0A43,
		0x0000,
		0xC802,
		0x0005,
		0x0000,
		0x0602,
		0x0408,
		0x0038,
		0x3001,
		0x2001,
		0x171C,
		0x15C0,
		0x0000,
		0x2120,
		0x272C,
		0x1C64,
		0xE2BF,
		0x1102,
		0x0E34,
		0x0624,
		0x0DB0,
		0x8001,
		0x0639,
		0x318C,
		0xB18C,
		0x0401,
		0x1401,
		0x0000,
		0x0010,
		0x3100,
		0x02EE,
		0x0500,
		0x0000,
		0x03E8,
		0x0000,
		0x0000,
		0x0000,
		0x0000,
		0x0000,
		0x0000,
		0x0300,
		0x0300,
		0x4180,
		0x0000,
		0x0080,
		0x203F,
		0x0000,
		0x0000,
		0x0000,
		0x0002,
		0x0001,
		0x0001,
		0x0000,
		0x1388,
		0x01F4,
		0x03E8,
		0x0000,
		0xC350,
		0x0080,
		0x0000,
		0x003F,
		0x1000,
		0x0000,
		0x0011,
		0x000E,
		0x0000,
		0x0000,
		0x0000,
		0x8A2D,
		0x0125,
		0x0000,
		0x0608,
		0x0002,
		0x011E,
		0x0000,
		0x0000,
		0x0000,
		0x0F00,
		0x0040,
		0x0000,
		0x0040,
		0xFF00,
		0x03FF,
		0x0000,
		0x0000,
		0x0000,
		0x0000,
		0x1000,
		0x0000,
		0x0000,
		0x17F8,
		0x0000,
		0x1C80,
		0x19B9,
		0x0533,
		0x03E8,
		0x0028,
		0x0014,
		0x0014,
		0x000A,
		0x0000,
		0x0000,
		0x0000,
		0x0000,
		0x001F,
		0x0000,
		0xFFFF,
		0x0000,
		0x0000,
		0x0000,
		0x0000,
		0x0000,
		0x0000,
		0x0000,
		0x0000,
		0x0000,
		0x0000
};


#else
// OctoLO, 100 MHz CLK. Generate 10 GHz, Pow 7.
uint16_t lmx_default_regs[LMX2820::N_REGS] = {
		0x6070,
		0xD7A0,
		0x81F4,
		0x0041,
		0x4204,
		0x0032,
		0x0A43,
		0x0000,
		0xC802,
		0x0005,
		0x0000,
		0x0602,
		0x0408,
		0x0038,
		0x3001,
		0x2001,
		0x171C,
		0x15C0,
		0x0000,
		0x2120,
		0x272C,
		0x1C64,
		0xE2BF,
		0x1102,
		0x0E34,
		0x0624,
		0x0DB0,
		0x8001,
		0x0639,
		0x318C,
		0xB18C,
		0x0401,
		0x1401,
		0x0000,
		0x0010,
		0x3100,
		0x0064,
		0x0500,
		0x0000,
		0x03E8,
		0x0000,
		0x0000,
		0x0000,
		0x0000,
		0x0000,
		0x0000,
		0x0300,
		0x0300,
		0x4180,
		0x0000,
		0x0080,
		0x203F,
		0x0000,
		0x0000,
		0x0000,
		0x0002,
		0x0001,
		0x0001,
		0x0000,
		0x1388,
		0x01F4,
		0x03E8,
		0x0000,
		0xC350,
		0x0080,
		0x0000,
		0x003F,
		0x1000,
		0x0000,
		0x0011,
		0x000E,
		0x0000,
		0x0000,
		0x0000,
		0x8A2D,
		0x0125,
		0x0000,
		0x0608,
		0x0001,
		0x011E,
		0x0000,
		0x0000,
		0x0000,
		0x0F00,
		0x0040,
		0x0000,
		0x0040,
		0xFF00,
		0x03FF,
		0x0000,
		0x0000,
		0x0000,
		0x0000,
		0x1000,
		0x0000,
		0x0000,
		0x17F8,
		0x0000,
		0x1C80,
		0x19B9,
		0x0533,
		0x03E8,
		0x0028,
		0x0014,
		0x0014,
		0x000A,
		0x0000,
		0x0000,
		0x0000,
		0x0000,
		0x001F,
		0x0000,
		0xFFFF,
		0x0000,
		0x0000,
		0x0000,
		0x0000,
		0x0000,
		0x0000,
		0x0000,
		0x0000,
		0x0000,
		0x0000
};



#endif

